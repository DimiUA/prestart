<!--suppress JSAnnotator -->
<template>
    <div class="page "> 
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#"  @click="promptQuit" class="link">
                        <i class="icon icon-back"></i>
                        <span class="ios-only">{{@global.LANGUAGE.COM_MSG00}}</span>
                    </a>
                </div>
                <div class="title sliding">{{Name}}</div>
                <div class="right">
                    <a href="#"  @click="promptQuit" class="link" >                
                        <i class="icon-header-close "></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="toolbar no-shadow toolbar-bottom-md tabbar-custom2">
            <div  class="toolbar-inner row bottom-buttons-wrapper">  
                <button key="ButtonShowPopupSummary" @click="showPopupSummary" class="col button button-fill button-big color-green {{#unless AllAnswered}} disabled {{/unless}}">{{@global.LANGUAGE.COM_MSG10}}</button>
            </div>
        </div>  

        <div class="page-content">
            <div class="list media-list no-hairlines">
                <ul>
                    {{#if Questions}}
                        {{#Questions}}
                        <li>
                            <div class="item-content" >
                                <div class="item-inner">
                                    <div class="item-title-row">
                                        <div class="item-title"></div>
                                        <div class="item-after">
                                            {{#if images}}
                                                <a  href="#" class="link color-blue showImages" data-images = "{{images}}"> {{@global.LANGUAGE.COM_MSG08}}</a>
                                            {{else}}
                                                {{@global.LANGUAGE.COM_MSG07}}                                           
                                            {{/if}}
                                        </div>
                                    </div>
                                    <div class="item-text text-color-white">                                    
                                        {{Name}}
                                    </div>  
                                    <div class="item-text margin-top">
                                        <div class="row" data-question-index="{{@index}}">
                                            <button class="col button button-fill color-red question-button showPopupFault">{{@global.LANGUAGE.QUESTIONS_MSG00}}</button>
                                            <button class="col button button-fill color-orange question-button " data-state="2">{{@global.LANGUAGE.QUESTIONS_MSG01}}</button>
                                            <button class="col button button-fill color-green question-button " data-state="1">{{@global.LANGUAGE.QUESTIONS_MSG02}}</button>
                                        </div> 
                                    </div> 
                                </div>
                            </div>
                        </li>
                        {{/Questions}}
                    {{else}}
                    <li>
                        <div class="item-content">
                            <div class="item-inner">                       
                                <div class="item-title">
                                    {{@global.LANGUAGE.COM_MSG09}} 
                                </div> 
                            </div>                                
                        </div>                            
                    </li>
                    {{/if}}
                </ul>
            </div>
        </div>

            
    </div>


        
</template>


<script>
  // script must return component object
    return {
        data: function () {
            var self = this;

            let checkListCode = this.$route.context.CheckListCode
            let checkLists = self.$app.methods.getFromStorage('checkList');
            //console.log(self);


            let checkList =  this.$app.methods.findObjectByKey(checkLists, 'Code', checkListCode);
            let questions =  this.$app.methods.sortArrayByObjProps(checkList.Options, [
                {
                    prop:'Order',
                    direction: 1
                },{
                    prop:'Name',
                    direction: 1
                }
            ]);

            if (questions && questions.length) {
                for (var i = questions.length - 1; i >= 0; i--) {
                    if (questions[i].images && questions[i].images.length === 0) {
                        questions[i].images = '';
                    }
                }
            }else{
                questions = '';
            }

            var ret = {
                //Questions: null,
                Name: checkList.Name,
                Questions: questions,
                Answers: {},
                AllAnswered: false,
            };   
           
           
            return ret;
        },
        methods: {
            promptQuit: function(params){               
                var self = this;
                this.$app.methods.customDialog({
                    text: LANGUAGE.PROMPT_MSG001,
                    title: self.Name,
                    buttons: [{
                        text: LANGUAGE.COM_MSG04,
                    },{
                        text: LANGUAGE.COM_MSG03,
                        onClick: function () {
                            mainView.router.back();
                            if (params && params.popup) {
                                params.popup.close();
                            }
                        }
                    }]
                })
            },
            promptStartTrip: function(params){
                var self = this;
                /*var modalTex = '<div class="color-red custom-modal-title">'+ self.Name +'</div>' +
                    '<div class="custom-modal-text">'+ LANGUAGE.PROMPT_MSG004 +'</div>';   */
                var modalTex = `
                    <div class="custom-modal-text margin-bottom">${ LANGUAGE.PROMPT_MSG004 }</div>
                    <div class="list no-margin  text-color-black">
                        <ul>
                            <li>
                                <label class="item-radio item-content color-red">
                                    <input type="radio" name="trip-type" value="business"  checked/>
                                    <i class="icon icon-radio"></i>
                                    <div class="item-inner">
                                        <div class="item-title">${ LANGUAGE.QUESTIONS_MSG12 }</div>
                                    </div>
                                </label>
                            </li>
                            <li>
                                <label class="item-radio item-content color-red">
                                    <input type="radio" name="trip-type" value="personal"  />
                                    <i class="icon icon-radio"></i>
                                    <div class="item-inner">
                                        <div class="item-title">${ LANGUAGE.QUESTIONS_MSG11 }</div>
                                    </div>
                                </label>
                            </li>                            
                            <li>
                                <label class="item-radio item-content color-red">
                                    <input type="radio" name="trip-type" value="diagnostic"  />
                                    <i class="icon icon-radio"></i>
                                    <div class="item-inner">
                                        <div class="item-title">${ LANGUAGE.QUESTIONS_MSG13 }</div>
                                    </div>
                                </label>
                            </li>                 
                        </ul>
                    </div>
                `;
                self.$app.dialog.create({
                       title: '<div class="custom-modal-logo-wrapper"><img class="custom-modal-logo" src="resources/images/logo-dark.png" alt=""/></div>',
                        text: modalTex,                                
                     buttons: [
                        {
                            text: LANGUAGE.COM_MSG11,
                            color: 'red',
                            onClick: function (dialog) { 
                                console.log(dialog);
                                var tripType = dialog.$el.find('input[name="trip-type"]:checked').val();
                                if (tripType !== 'diagnostic') {
                                    let obj = {
                                        TripStarted: true,
                                        Trip: {
                                            AssetName: 'Asset3',
                                            StartTime: '20/10/2018 12:34:45',
                                        }
                                    };
                                    AppEvents.emit('tripStatusChanged', obj);
                                    self.$app.methods.setInStorage({
                                        name: 'additionalFlags',
                                        data: obj
                                    });//localStorage.TripStarted = 1;
                                }
                                self.$app.view.main.router.back();
                                //mainView.router.back('/',{force: true});
                                if (params && params.popup) {
                                    params.popup.close();
                                }
                            }
                        }
                        
                    ]
                }).open();                 
            },               
            showPopupFault: function(questionIindex){
                var self = this;
                //var name = self.Name;

                var question = self.Answers[questionIindex];              

                    self.$app.popup.create({
                    //closeByBackdropClick: false,
                    content: 
                        `<div class="popup fault-popup">
                            <div class="view">
                                <form class="page faultForm" data-question-index="${ questionIindex }">
                                    <div class="navbar">
                                        <div class="navbar-inner">
                                            <div class="left">
                                                <a href="#" class="link popup-close">
                                                    <i class="icon icon-back"></i>
                                                    <span class="ios-only">${ LANGUAGE.COM_MSG00 }</span>
                                                </a>
                                            </div>
                                            <div class="title">${ self.Questions[questionIindex].Name }</div>
                                        </div>
                                    </div>
                                    <div class="toolbar no-shadow toolbar-bottom-md tabbar-custom2">
                                        <div class="toolbar-inner row bottom-buttons-wrapper">                    
                                            <button type="submit" class="col button button-fill button-big color-green">${ LANGUAGE.COM_MSG01 }</button>                               
                                        </div>
                                    </div>
                                    <div class="page-content">
                                        <div class="top-img-wrapper">
                                            <div class="top-img-content">
                                               <!-- <img data-name="prestartp_test.jpg" src="https://res.cloudinary.com/dmuibj5uf/image/upload/v1591374240/sinoafrica/pckahbvv5pt7lgo0rjac.png" class="">-->
                                                <!--<img src="https://res.cloudinary.com/dmuibj5uf/image/upload/v1591374240/sinoafrica/pznildufcdyobjdss29k.png" class="">-->
                                            </div>
                                            <div class="top-img-load-button bg-color-white showUploadPhotoOptions">
                                                <i class="f7-icons icon-font icon-other-photo text-color-dark-grey"></i>
                                            </div>
                                        </div>
                                        <div class="list no-hairlines">
                                            <ul>                        
                                                <li class="item-content item-input ">
                                                    <div class="item-media text-color-gray"><i class="f7-icons icon-font icon-other-fail"></i></div>
                                                    <div class="item-inner">
                                                        <div class="item-title item-label">${ LANGUAGE.QUESTIONS_MSG03 }</div>
                                                        <div class="item-input-wrap input-dropdown-wrap">
                                                          <select name="failReason" placeholder="Please choose..." required validate>
                                                            <option value="1" ${ question && question.failReason == 1 ? 'selected' : '' }>Not Working</option>
                                                            <option value="2" ${ question && question.failReason == 2 ? 'selected' : '' }>Other</option>
                                                          </select>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="item-content item-input ">
                                                    <div class="item-media text-color-gray"><i class="f7-icons icon-font icon-other-notes"></i></div>
                                                    <div class="item-inner">
                                                        <div class="item-title item-label">${ LANGUAGE.QUESTIONS_MSG04 }</div>
                                                        <div class="item-input-wrap ">
                                                            <textarea name="failNotes" required validate>${ question && question.notes ? question.notes : '' }</textarea>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>                                                    
                                        </div>                        
                                    </div>
                                </form>
                            </div>         
                        </div>`,
                    on: {
                        opened: function (popup) {
                            popup.$el.find('.showUploadPhotoOptions').on('click', function (e) {
                                //self.showUploadPhotoOptions();
                                self.loadEditImageModal()
                            })
                            popup.$el.find('.faultForm').on('submit', function(e){
                                e.preventDefault();
                                self.saveFault(popup);
                                return false;
                            });
                        },                        
                    }                  
                }).open();              
            },
            showUploadPhotoOptions: function(){
                let self = this;
                self.$app.actions.create({
                    buttons: [
                        {
                            //text: LANGUAGE.COM_MSG074,
                            text: `<div class="action_button_wrapper">
                                    <div class="action_button_block action_button_media text-color-gray">
                                        <i class="f7-icons icon-other-image size-20"></i>
                                    </div>
                                    <div class="action_button_block action_button_text">
                                        ${ LANGUAGE.COM_MSG15 }
                                    </div>
                                </div>`,
                            onClick: function () {
                                self.getImageFromDevice(1);
                            }
                        },
                        {
                            //text: LANGUAGE.PROMPT_MSG025,
                            text: `<div class="action_button_wrapper">
                                    <div class="action_button_block action_button_media text-color-gray">
                                        <i class="f7-icons icon-other-photo size-20"></i>
                                    </div>
                                    <div class="action_button_block action_button_text">
                                        ${ LANGUAGE.COM_MSG16 }
                                    </div>
                                </div>`,
                            onClick: function () {
                                self.getImageFromDevice(0);
                            }
                        },{
                            //text: LANGUAGE.COM_MSG001,
                            text: `<div class="action_button_wrapper">
                                    <div class="action_button_block action_button_media text-color-red">
                                        <i class="f7-icons icon-header-close size-16"></i>
                                    </div>
                                    <div class="action_button_block action_button_text">
                                        ${ LANGUAGE.COM_MSG17 }
                                    </div>
                                </div>`,
                            color: 'red',
                        },
                    ]
                }).open();
            },
            getImageFromDevice: function(source=1){
                let self = this;
                if (!navigator.camera) {
                    self.$app.methods.customDialog({title:LANGUAGE.PROMPT_MSG012, text: LANGUAGE.PROMPT_MSG013});
                    return;
                }
                let options = {
                    quality: 50,
                    destinationType: Camera.DestinationType.DATA_URL,
                    sourceType: source, // 0:Photo Library, 1=Camera, 2=Saved Album
                    encodingType: 0 // 0=JPG 1=PNG
                };

                navigator.camera.getPicture(
                        function(imgData) {
                            self.loadEditImageModal("data:image/jpeg;base64," + imgData);
                        },
                        function() {
                            self.$app.methods.customDialog({title:LANGUAGE.PROMPT_MSG012, text: LANGUAGE.PROMPT_MSG014});
                            //alert('Error taking picture', 'Error');
                        },
                        options);
            },
            loadEditImageModal: function(src){
                let self = this;
                self.$app.progressbar.hide();
                self.$app.popup.create({
                    closeByBackdropClick: false,
                    content:
                            `<div class="popup edit-image-popup">
                            <div class="view">
                                <div class="page">
                                    <div class="navbar">
                                        <div class="navbar-bg"></div>
                                        <div class="navbar-inner">
                                            <div class="left">
                                                <a href="#" class="link popup-close icon-only">
                                                    <i class="f7-icons">close</i>
                                                </a>
                                            </div>
                                            <div class="title">` + LANGUAGE.COM_MSG18 + `</div>
                                            <div class="right">
                                                <a href="#" class="link saveEditedImage" >
                                                    <i class="f7-icons">check</i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="page-content">
                                        <div class="asset_img_before_crop" style="">
                                            <img style="max-width: 980px; max-height: 980px; " id="image" src="` + src + `">
                                        </div>
                                        <button type="button" class="button button-fill text-color-black redo"><span class="f7-icons">forward</span></button>
                                        <button type="button" class="button button-fill text-color-black undo"><span class="f7-icons">reply</span></button>

                                    </div>
                                </div>
                            </div>
                        </div>`,
                    on: {
                        opened: function (popup) {
                            let cropper = self.initCropper();
                            popup.$el.find('.saveEditedImage').on('click', function(){
                                self.saveImage(cropper);
                            });
                            popup.$el.find('.redo').on('click', function(){
                                cropper.rotate(90);
                            });
                            popup.$el.find('.undo').on('click', function(){
                                cropper.rotate(-90);
                            });
                        },
                    }
                }).open();
            },
            initCropper: function (){
                let image = document.getElementById('image');
                let cropper = new Cropper(image, {
                    aspectRatio: NaN,
                    dragMode:'move',
                    rotatable:true,
                    minCropBoxWidth:200,
                    minCropBoxHeight:200,
                    minCanvasWidth:200,
                    minCanvasHeight:200,
                    minContainerWidth:200,
                    minContainerHeight:200,
                    crop: function(data) {
                    }
                });
                return cropper;
            },
            saveImage: function(cropper){
                let self = this;

                let resImg =  cropper.getCroppedCanvas({
                    minWidth: 200,
                    minHeight: 200
                }).toDataURL("image/jpeg",0.7);

                self.$app.data.NewImageTimestamp = new Date().getTime();
                let assetImg = {
                    data: resImg,
                    id: 'Prestart_'+NewImageTimestamp
                };

                self.$app.dialog.progress();
                self.$app.request.promise.post(API_URL.PHOTO_UPLOAD, assetImg, 'json')
                        .then(function (result) {
                            self.$app.dialog.close();
                            if(result.data.MajorCode === '000') {
                                console.log(result.data);
                                $$('.fault-popup .top-img-content').html(`<img data-name="${result.data.Data}" src="${API_DOMIAN9}Attachment/images/${result.data.Data+'?'+ self.$app.data.NewImageTimestamp}" alt="">`);

                            }else{
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG023 + `<br>MajorCode: ${result.data.MajorCode}<br>MinorCode: ${result.data.MinorCode}<br>${result.data.Data}`);
                            }
                            self.$app.popup.close();
                        })
                        .catch(function (err) {
                            console.log(err);
                            self.$app.dialog.close();
                            if (err && err.status === 404){
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG015);
                            }else{
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG008);
                            }
                        });
            },
            showPopupSummary: function(){
                var self = this;
                var name = self.Name;

                console.log(self.Answers);
                var summary = {
                    1: 0,  //pass
                    2: 0,  //na
                    3: 0,  //fault
                };

                // counting answers states
                for (const key of Object.keys(self.Answers)) {                    
                    summary[self.Answers[key].state]++;
                }

                self.$app.popup.create({
                    content: 
                        `<div class="popup fault-popup">
                            <div class="view">
                                <div class="page">
                                    <div class="navbar">
                                        <div class="navbar-inner">
                                            <div class="left">
                                                <a href="#" class="link popup-close">
                                                    <i class="icon icon-back"></i>
                                                    <span class="ios-only">${ LANGUAGE.COM_MSG00 }</span>
                                                </a>
                                            </div>
                                            <div class="title">${ name }</div>  
                                            <div class="right">
                                                <a href="#" class="link promptQuitPopup" >                
                                                    <i class="icon-header-close "></i>
                                                </a>
                                            </div>                              
                                        </div>
                                    </div>
                                    <div class="toolbar no-shadow toolbar-bottom-md tabbar-custom2">
                                        <div class="toolbar-inner row bottom-buttons-wrapper">                    
                                            <button class="col button button-fill button-big color-green submitChecklist">${ LANGUAGE.COM_MSG02 }</button>                               
                                        </div>
                                    </div>
                                    <div class="page-content">
                                        <div class="block-title block-title-custom">${ LANGUAGE.QUESTIONS_MSG07 }</div>
                                        <div class="block row">
                                            <div class="col-33 with-border-radius text-color-white bg-color-red text-align-center padding-vertical">
                                                <div><i class="f7-icons icon-other-fail size-36 padding-bottom-8"></i></div>
                                                <div>${ LANGUAGE.QUESTIONS_MSG08 }</div>
                                                <div>${ summary[3] }</div>
                                            </div>
                                            <div class="col-33 with-border-radius text-color-white bg-color-orange text-align-center padding-vertical">
                                                <div><i class="f7-icons icon-other-na-items size-36 padding-bottom-8"></i></div>
                                                <div>${ LANGUAGE.QUESTIONS_MSG09 }</div>
                                                <div>${ summary[2] }</div>
                                            </div>
                                            <div class="col-33 with-border-radius text-color-white bg-color-green text-align-center padding-vertical">
                                                <div><i class="f7-icons icon-other-passed-items size-36 padding-bottom-8"></i></div>
                                                <div>${ LANGUAGE.QUESTIONS_MSG10 }</div>
                                                <div>${ summary[1] }</div>
                                            </div>
                                        </div>
                                        <div class="block">
                                            <p>${ LANGUAGE.PROMPT_MSG002 }</p>  
                                            <p class="text-color-white">${ LANGUAGE.PROMPT_MSG003 }</p>
                                        </div>
                                       
                                    </div>
                                </div>
                            </div>         
                        </div>`,
                    on: {
                        opened: function (popup) {                            
                            $$('.promptQuitPopup').on('click', function(){
                                self.promptQuit({popup: popup});
                            });
                            $$('.submitChecklist').on('click', function(){
                                self.promptStartTrip({popup: popup});
                            });
                        },                        
                    }                  
                }).open();

            },
            saveFault: function(popup){
                var self = this;                
                var page = $$(self.$router.currentPageEl);
                var questionIndex = popup.$el.find('form.faultForm').data('question-index');  
                var failReasonSelect = popup.$el.find('[name = "failReason"]');
                

                self.Answers[questionIndex] = {
                    number: questionIndex, 
                    state: '3',
                    failReason: failReasonSelect.val(),
                    failReasonText: failReasonSelect[0].options[failReasonSelect[0].selectedIndex].text,
                    notes: popup.$el.find('[name = "failNotes"]').val(),
                    image: popup.$el.find('.top-img-content img').data('name'),
                };


                popup.close();
                page.find('.row[data-question-index ="'+questionIndex+'"] .showPopupFault').addClass('active');
                self.checkIsAllAnswered();
                //console.log(self.Answers);
                
            },
            checkIsAllAnswered: function(){
                var self = this;

                var answeredCount = 0;
                for (const key of Object.keys(self.Answers)) {                    
                    answeredCount++;
                }
                if (answeredCount == self.Questions.length) {
                    self.$setState({ AllAnswered: true });                   
                }else{
                    self.$setState({ AllAnswered: false });                   
                }                
            }
            /*submitChecklist: function(){
                var self = this;


                //self.promptStartTrip();
            }, */

        },


        on: {
            pageInit: function (e, page) { 
                var self = this;   
                //var app = self.$app;
                
                page.$pageEl.find('.showPopupFault').on('click', function(){
                    var questionIndex = $$(this).closest('.row').data('question-index');
                    self.showPopupFault(questionIndex);
                });

                page.$pageEl.find('.showImages').on('click', function(){                  
                    var imagesStr = $$(this).data('images');
                    if (imagesStr) {
                        app.photoBrowser.create({
                            photos : imagesStr.split(","),
                            type: 'popup',
                            theme: 'dark',
                        }).open();
                    }   
                });
                
                page.$pageEl.find('.question-button').on('click', function(){    
                    var that = $$(this); 
                    var parent = that.closest('.row');
                    var buttonsInRow = parent.find('.question-button'); 
                    var questionIndex = parent.data('question-index');
                    

                    if (!that.hasClass('showPopupFault')) {
                        buttonsInRow.removeClass('active');
                        self.Answers[questionIndex] = {
                            number: questionIndex, 
                            state: that.data('state'),
                        };
                        that.addClass('active');
                        self.checkIsAllAnswered();
                    }else{
                        if (self.Answers[questionIndex] && self.Answers[questionIndex].state != '3') {
                            buttonsInRow.removeClass('active');
                            delete self.Answers[questionIndex];
                            self.checkIsAllAnswered();
                        }
                    }
                    
                });       
                
                
            },     
            
        }
    };
</script>