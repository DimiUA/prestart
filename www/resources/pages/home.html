<!--suppress JSAnnotator -->
<template>
<!-- Page, data-name contains page name which can be used in callbacks -->
        <div class="page " > <!-- page-with-subnavbar -->
        <!-- Top Navbar -->
            <div class="navbar">
                <div class="navbar-bg"></div>
                <div class="navbar-inner">
                    <div class="left">
                        <a href="/panel-left/" class="link icon-only">
                            <i class="icon f7-icons ios-only">menu</i>
                            <i class="icon material-icons md-only">menu</i>
                          </a>
                    </div>
                    <div class="title sliding">{{@global.LANGUAGE.HOME_MSG00}}</div>
                    <div class="right">
                        <!-- <a href="#" class="link panel-open" data-panel="right">                
                           Фильтр <i class="icon material-icons ">filter_list</i>
                        </a>  -->
                    </div>

                   
                </div>
            </div>

            <div class="toolbar no-shadow toolbar-bottom-md tabbar-custom2">
                <div  class="toolbar-inner row bottom-buttons-wrapper">
                    {{#if TripStarted}}
                    <button key="ButtonFinishTrip" @click="finishTrip" class="col button button-fill button-big color-red ">{{@global.LANGUAGE.COM_MSG06}}</button>
                    {{else}}
                    <button key="ButtonStartQuestions" @click="goToQuestions" class="col button button-fill button-big color-green ">{{@global.LANGUAGE.COM_MSG05}}</button>
                    {{/if}} 
                </div>
            </div>
        
            <!-- Scrollable page content-->
            <div class="page-content">                
                
                {{#if TripStarted}}

                <div key="BlockSelectedVehicle">
                   <div class="block-title ">{{@global.LANGUAGE.HOME_MSG05}}</div>
                    <div class="list no-hairlines">
                        <ul>
                            {{#Trip}}
                            
                            <li>
                                <div class="item-content"> 
                                    <div class="item-media text-color-gray">
                                        <i class="f7-icons icon-other-asset "></i>
                                    </div>                      
                                    <div class="item-inner">
                                        <div class="item-title">
                                            <div class="item-header item-label">{{@global.LANGUAGE.HOME_MSG06}}</div>
                                            {{AssetName}}
                                        </div>                                
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content"> 
                                    <div class="item-media text-color-gray">
                                        <i class="f7-icons icon-other-date "></i>
                                    </div>                      
                                    <div class="item-inner">
                                        <div class="item-title">
                                            <div class="item-header item-label">{{@global.LANGUAGE.HOME_MSG07}}</div>
                                            {{StartTime}}
                                        </div>                                
                                    </div>
                                </div>
                            </li>
                            {{/Trip}}
                        </ul>
                    </div>
                </div>

                {{else}}

                <div key="BlockSelectChecklist" class="list no-hairlines">
                    <ul>
                        <li>
                            <a
                                    key="key-asset-list"
                                    class="item-link smart-select custom-smart-select smart-select-asset-list"
                            >
                                <select name="asset"  >
                                    {{#AssetList}}
                                    <option value="{{IMEI}}" >{{Name}}</option>
                                    {{/AssetList}}
                                </select>
                                <div class="item-content item-input">
                                    <div class="item-media text-color-gray">
                                        <i class="f7-icons icon-font icon-other-asset"></i>
                                    </div>
                                    <div class="item-inner ">
                                        <div class="item-title item-label">{{@global.LANGUAGE.HOME_MSG01}}</div>
                                    </div>
                                </div>
                            </a>
                        </li>

                        <li>
                            <a class="item-link smart-select custom-smart-select smart-select-check-list" >
                                <select name="checklist">
                                    {{#CheckList}}
                                    <option value="{{Code}}" >{{Name}}</option>
                                    {{/CheckList}}
                                </select>
                                <div class="item-content item-input">
                                    <div class="item-media text-color-gray">
                                        <i class="f7-icons icon-font icon-other-checklist"></i>
                                    </div>
                                    <div class="item-inner ">
                                        <div class="item-title item-label">{{@global.LANGUAGE.HOME_MSG02}}</div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="item-content">
                            <div class="item-inner">
                                <div class="item-title">
                                {{@global.LANGUAGE.HOME_MSG03}}
                                <div class="item-footer">{{@global.LANGUAGE.PROMPT_MSG000}}</div>
                                </div>
                                <div class="item-after">
                                    <label class="toggle color-red">
                                        <input type="checkbox" name="driving-car" checked="checked">
                                        <span class="toggle-icon"></span>
                                    </label>
                                </div>
                            </div>
                        </li>                    
                    </ul>                                        
                </div>



                {{/if}}


                
                

            </div>
        </div>
    </template>


<script>
  // script must return component object
    return {
        data: function () {
            var self = this;

            let assetList = self.$app.methods.getFromStorage('assetList');
            let checkList = self.$app.methods.getFromStorage('checkList');

            let additionalFlags = self.$app.methods.getFromStorage('additionalFlags');
            var ret = {
                AssetList: assetList,
                CheckList: checkList,
                Trip: additionalFlags.Trip
            };
            //app.methods.storageSetupTime();

            ret.TripStarted = additionalFlags.TripStarted;

            return ret;
        },
        methods: {
            userSignedIn(params){
                //console.log('here')
                this.$setState({
                    AssetList: params.Devices,
                    CheckList: params.CheckList
                },()=>{
                    this.initAssetList()
                    this.initCheckList()
                })
            },
            tripStatusChanged(params){
                if (params.TripStarted) {
                    console.log('here')
                    this.$setState({
                        TripStarted: params.TripStarted,
                        Trip: params.Trip
                    }, ()=>{
                        console.log('updated')
                    });
                }else{
                    this.$setState({
                        TripStarted: params.TripStarted,
                    }, ()=>{
                        this.initAssetList();
                        this.initCheckList();
                    });
                }
            },

            initAssetList(){
                if(this.AssetListSelect){
                    this.AssetListSelect.destroy();
                }
                let listEl = this.$el.find('.smart-select-asset-list');
                if(listEl.length){
                    this.AssetListSelect = this.$app.smartSelect.create({
                        el: listEl,
                        openIn: 'popup',
                        formColorTheme: 'red',
                        //popupPush: true,
                        searchbar: true,
                        searchbarPlaceholder: LANGUAGE.COM_MSG13,
                        appendSearchbarNotFound: LANGUAGE.PROMPT_MSG009,
                        //pageTitle: LANGUAGE.COM_MSG065,
                        /* on: {
							 change: function (smartSelect, val) {
								 self.updateGroupMarkers(val);
							 }
						 }*/
                    });
                }
            },
            initCheckList(){
                if(this.CheckListSelect){
                    this.CheckListSelect.destroy();
                }
                let listEl = this.$el.find('.smart-select-check-list');
                if(listEl.length){
                    this.CheckListSelect = this.$app.smartSelect.create({
                        el: listEl,
                        openIn: 'popup',
                        formColorTheme: 'red',
                        //popupPush: true,
                        searchbar: true,
                        searchbarPlaceholder: LANGUAGE.COM_MSG13,
                        appendSearchbarNotFound: LANGUAGE.PROMPT_MSG009,
                        //pageTitle: LANGUAGE.COM_MSG065,
                        /* on: {
							 change: function (smartSelect, val) {
								 self.updateGroupMarkers(val);
							 }
						 }*/
                    });
                }
            },
            /*getCheckLists(){
                /!*app.dialog.progress();
                app.request.get(API_URL.GET_QUESTIONS, {}, function (data, xhr, status) {
                    console.log(data);

                    app.dialog.close();
                },
                function (xhr, status) {
                    app.dialog.close();
                    //app.dialog.alert('Error occurred during get categories request!');
                    app.dialog.alert('Error occured');
                },
                'json');  *!/
                let checkLists = [
                    {
                        Id: 1,
                        Name: 'Check List 1',
                        Questions: [
                            {
                                question: 'Check engine oil level, coolant level, washer water level, fuel level in tanks',
                                images: '',
                            },
                            {
                                question: 'Visually check for fluid leaks of oil, coolant, fuel, brake/clutch fluid (if applicable)',
                                images: ['http://oi67.tinypic.com/2evyh3k.jpg','http://oi64.tinypic.com/2eamloy.jpg'],
                            },
                            {
                                question: 'Check cab entry/exit steps & handles - check seats and seat belts',
                                images: ['http://oi64.tinypic.com/2eamloy.jpg'],
                            },
                            {
                                question: 'Start engine - check oil pressure, warm up engine, build up air pressure. Check instruments, gauges, brake failure, indicators & dash controls.',
                                images: [],
                            },
                            {
                                question: 'Check registration is current',
                                images: ['http://oi64.tinypic.com/2eamloy.jpg'],
                            },
                        ]
                    }
                ];
                /!*
                    'Drain condensation & contamination from all air tanks',
                    'Check triangles & safety kit (first aid) are on/in the vehicle',
                    'Check all tyres for tread, damage & inflation - including spares',
                    'Visually check wheels and wheel nuts and spare wheel carriers',
                    'Check ALL lights, clearance lights, hazards, reflectors, lenses are intact & working',
                    'Check wipers, washers, windows and mirrors are clean & operational',
                    'Visually check chassis, suspension including air bags, check cab & body for damage',
                    'Check warning devices',
                    'Check trailer couplings for leaks - air / electrical / hydraulic (if applicable)',
                    'Check that mudguards & mudflaps are securely fitted',
                    'Check number plates are secure & intact',
                    'ug test to ensure secure truck/trailer connection',
                    'When commenced driving apply brakes at low speed to ensure operation & release',
                    'Check Service Sticker is not overdue',
                *!/

                this.$app.methods.setInStorage({
                    name: 'checkList',
                    data: checkLists
                });

                this.$setState({
                    CheckList: checkLists
                }, ()=>{
                    console.log(checkLists)
                    this.initCheckList()
                })
            },*/

            goToQuestions: function(){
                if(!this.CheckListSelect.getValue()){
                    this.$app.methods.customDialog({text: LANGUAGE.PROMPT_MSG010})
                    return;
                }
                if(!this.AssetListSelect.getValue()){
                    this.$app.methods.customDialog({text: LANGUAGE.PROMPT_MSG011})
                    return;
                }
                var params = {
                    CheckListCode: this.CheckListSelect.getValue(),
                    IMEI: this.AssetListSelect.getValue(),

                };

                this.$app.view.main.router.navigate('/questions/', { context: params } );
            }, 
            finishTrip: function(){
                var self = this; 

                var params = {};

                let obj = {
                    TripStarted: false
                }
                self.$app.methods.setInStorage({name: 'additionalFlags', data: obj});
                self.$app.view.main.router.navigate('/trip-info/8/Asset3/', { context: params } );
                AppEvents.emit('tripStatusChanged', obj);

                //localStorage.TripStarted = 0;
            },

        },
       
        on: {
            pageInit: function (e, page) { 
                var self = this;

                AppEvents.on('signedIn', self.userSignedIn);
                AppEvents.on('tripStatusChanged', self.tripStatusChanged);

                if(!self.TripStarted){
                    this.initAssetList();
                    this.initCheckList();
                }

                
            },
            pageBeforeRemove: function () {
                AppEvents.off('signedIn', this.userSignedIn);
                if(this.AssetListSelect) this.AssetListSelect.destroy();
                if(this.CheckListSelect) this.CheckListSelect.destroy();

                
            }
        }
    };
</script>